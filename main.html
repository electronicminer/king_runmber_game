<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>国王大乱斗 - 联机诊断版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Playfair+Display:ital,wght@1,700&display=swap');
        body { margin: 0; overflow: hidden; background-color: #2a0a12; touch-action: none; user-select: none; font-family: 'Playfair Display', serif; }
        canvas { display: block; }
        .royal-btn { background: linear-gradient(to bottom, #b91c1c, #7f1d1d); border: 2px solid #fcd34d; color: #fef3c7; font-family: 'Cinzel Decorative', cursive; transition: transform 0.1s; }
        .royal-btn:active { transform: translateY(2px); }
        .royal-btn:disabled { filter: grayscale(1); cursor: not-allowed; }
    </style>
</head>
<body>

    <!-- 登录界面 -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center z-50 bg-black/90">
        <div class="bg-gray-900 border-4 border-yellow-600 p-8 rounded-lg max-w-md w-full text-center shadow-2xl">
            <h1 class="text-4xl text-yellow-500 mb-2 font-bold" style="font-family: 'Cinzel Decorative'">King's Rumble</h1>
            <p class="text-gray-400 text-sm mb-6">强制联机诊断版 v1.0</p>
            
            <input type="text" id="username-input" class="w-full bg-black border border-yellow-700 text-yellow-100 p-3 rounded mb-4 text-center" placeholder="输入你的名字" maxlength="8">
            
            <!-- 状态显示区域 -->
            <div id="connection-status" class="bg-black/50 p-4 rounded text-left text-xs font-mono space-y-1 mb-4 border border-gray-700">
                <div id="step-1" class="text-gray-500">1. 初始化 Firebase... <span class="loading">⏳</span></div>
                <div id="step-2" class="text-gray-500">2. 连接身份验证服务 (Auth)... <span class="loading">⏳</span></div>
                <div id="step-3" class="text-gray-500">3. 连接数据库 (Firestore)... <span class="loading">⏳</span></div>
            </div>

            <button id="start-btn" class="royal-btn w-full py-3 text-xl rounded" disabled>等待连接...</button>
        </div>
    </div>

    <!-- 错误弹窗 (平时隐藏) -->
    <div id="error-modal" class="hidden fixed inset-0 flex items-center justify-center z-[100] bg-black/95">
        <div class="bg-red-900/90 border-4 border-red-500 p-6 max-w-lg w-full rounded text-white shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">❌ 连接失败 (Critical Error)</h2>
            <div class="bg-black p-4 rounded font-mono text-sm text-red-300 break-all mb-4" id="error-details">
                Unknown Error
            </div>
            <p class="text-sm mb-4">请根据上方错误代码检查 Firebase 设置：</p>
            <ul class="text-sm list-disc list-inside space-y-2 text-gray-200 mb-6">
                <li><b>auth/operation-not-allowed</b>: 未在控制台开启“匿名登录”。</li>
                <li><b>auth/unauthorized-domain</b>: 未将 GitHub 域名添加到授权白名单。</li>
                <li><b>auth/configuration-not-found</b>: API Key 配置错误。</li>
            </ul>
            <button onclick="location.reload()" class="bg-white text-red-900 px-4 py-2 rounded font-bold hover:bg-gray-200">刷新重试</button>
        </div>
    </div>

    <div id="game-ui" class="hidden pointer-events-none fixed inset-0">
        <div class="absolute top-4 right-4 text-yellow-500 font-bold bg-black/50 px-4 py-2 rounded border border-yellow-600">
            在线玩家: <span id="player-count">1</span>
        </div>
        <!-- 摇杆区域 -->
        <div id="joystick-zone" class="absolute bottom-10 left-10 w-32 h-32 bg-yellow-600/20 rounded-full border-2 border-yellow-600/50 pointer-events-auto hidden">
            <div id="joystick-knob" class="absolute top-1/2 left-1/2 w-12 h-12 bg-yellow-500 rounded-full -translate-x-1/2 -translate-y-1/2 shadow-lg"></div>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // UI 元素
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');
        const startBtn = document.getElementById('start-btn');
        const errorModal = document.getElementById('error-modal');
        const errorDetails = document.getElementById('error-details');

        // 标记成功函数
        function markSuccess(el) {
            el.className = "text-green-400 font-bold";
            el.innerHTML = el.innerText.replace('⏳', '✅').replace('...', '') + ' [OK]';
        }
        function markFail(el) {
            el.className = "text-red-500 font-bold";
            el.innerHTML = el.innerText.replace('⏳', '❌');
        }

        // --- 1. 初始化 Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCO8cH3uF3mPnQKOLo4pMsOpMF8ZigMnz8",
            authDomain: "king-rumble.firebaseapp.com",
            projectId: "king-rumble",
            storageBucket: "king-rumble.firebasestorage.app",
            messagingSenderId: "897215414286",
            appId: "1:897215414286:web:2234622388138dfd84bc5f",
            measurementId: "G-JEFKGG38M3"
        };
        
        // 生产环境 Collection 名称
        const COLLECTION_NAME = 'kings_rumble_royal_prod'; 
        const APP_ID_PATH = 'king-rumble-game-room';

        let app, auth, db, currentUser;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            markSuccess(step1);
        } catch (e) {
            markFail(step1);
            showError(e);
        }

        // --- 2. 执行登录 ---
        async function connect() {
            try {
                // 强制使用匿名登录 (GitHub Pages 必须使用这个)
                await signInAnonymously(auth);
            } catch (error) {
                markFail(step2);
                showError(error);
            }
        }
        connect();

        // 监听登录状态
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                markSuccess(step2);
                startFirestoreListener(); // 登录成功后立刻监听数据库
            }
        });

        // --- 3. 监听数据库 ---
        let players = {};
        let myState = { x: 0, y: 0, vx: 0, vy: 0, color: '#ef4444', name: 'Player' };
        
        function startFirestoreListener() {
            try {
                const playersRef = collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', COLLECTION_NAME);
                
                // 设置监听器
                onSnapshot(playersRef, (snapshot) => {
                    // 第一次收到数据，或者数据更新，都代表连接数据库成功
                    if (!step3.classList.contains('text-green-400')) {
                        markSuccess(step3);
                        startBtn.disabled = false;
                        startBtn.innerText = "进入游戏";
                        startBtn.classList.add('animate-pulse');
                    }
                    
                    snapshot.docChanges().forEach((change) => {
                        const data = change.doc.data();
                        const pid = change.doc.id;
                        if (pid === currentUser.uid) return;
                        
                        if (change.type === "added" || change.type === "modified") {
                            if (!players[pid]) players[pid] = { ...data };
                            else {
                                players[pid].targetX = data.x;
                                players[pid].targetY = data.y;
                                players[pid].color = data.color;
                                players[pid].name = data.name;
                            }
                        }
                        if (change.type === "removed") delete players[pid];
                    });
                    
                    document.getElementById('player-count').innerText = Object.keys(players).length + 1;
                    
                }, (error) => {
                    // 监听器报错 (通常是权限问题)
                    markFail(step3);
                    showError(error);
                });
                
            } catch (e) {
                markFail(step3);
                showError(e);
            }
        }

        // 显示错误弹窗
        function showError(error) {
            console.error(error);
            errorModal.classList.remove('hidden');
            let msg = `${error.code}\n${error.message}`;
            errorDetails.innerText = msg;
        }

        // --- 简单的游戏逻辑 (为了让能跑起来验证联机) ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let isPlaying = false;

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();

        startBtn.onclick = () => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            const name = document.getElementById('username-input').value || "Knight";
            myState.name = name;
            myState.x = canvas.width/2;
            myState.y = canvas.height/2;
            isPlaying = true;
            
            if('ontouchstart' in window) document.getElementById('joystick-zone').classList.remove('hidden');
            loop();
        };

        // 简单的输入控制
        const keys = {};
        window.onkeydown = e => keys[e.key] = true;
        window.onkeyup = e => keys[e.key] = false;

        let lastUpload = 0;

        function loop() {
            if(!isPlaying) return;
            requestAnimationFrame(loop);

            // 移动
            if(keys['w']) myState.y -= 5;
            if(keys['s']) myState.y += 5;
            if(keys['a']) myState.x -= 5;
            if(keys['d']) myState.x += 5;

            // 绘制
            ctx.fillStyle = '#2a0a12';
            ctx.fillRect(0,0,canvas.width, canvas.height);
            
            // 画别人
            for(let pid in players) {
                const p = players[pid];
                // 简单插值
                if(p.targetX) { p.x = (p.x||p.targetX)*0.9 + p.targetX*0.1; p.y = (p.y||p.targetY)*0.9 + p.targetY*0.1; }
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 20, 0, Math.PI*2); ctx.fill();
            }

            // 画自己
            ctx.fillStyle = '#fbbf24';
            ctx.beginPath(); ctx.arc(myState.x, myState.y, 20, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white';
            ctx.fillText(myState.name, myState.x - 10, myState.y - 30);

            // 上传 (每100ms)
            const now = Date.now();
            if(now - lastUpload > 100 && currentUser) {
                setDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', COLLECTION_NAME, currentUser.uid), {
                    x: myState.x, y: myState.y, color: myState.color, name: myState.name, timestamp: now
                });
                lastUpload = now;
            }
        }
    </script>
</body>
</html>
